# serverless.yml

service: serverless-video-metadata-generator

custom:
  region: - Ref: AWS::Region
  accountId: - Ref: AWS::AccountId
  snsTopicName: your-notification-sns-topic
  snsTopicArn: arn:aws:sns:${self.custom.region}:${self.custom.accountId}:${self:custom:snsTopicName}
  snsPublishRoleName: snsPublishRole
  snsPublishRoleArn: arn:aws:iam:${self.custom.region}:${self.custom.accountId}:${self:custom:snsPublishRoleName}

provider:
  name: aws
  runtime: nodejs6.10
  environment:
    SNS_PUBLISH_ROLE_ARN: ${self:custom.snsPublishRoleArn}

functions:
  extractMetadata:
    handler: handler.extractMetadata
    events:
      - s3: 
          bucket: your-uploads-bucket
          event: s3:ObjectCreated:*
  saveMetadata:
    handler: handler.saveMetadata
    events: 
      - sns: ${self:custom.snsTopicName}

resources:
  Resources:
    snsPublishRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:custom.snsPublishRoleName}
        AssumeRolePolicyDocument: 
          Version: '2012-10-17'
          Statement: 
            - Effect: Allow
              Principal: 
                Service: 
                  - rekognition.amazonaws.com
              Action: 
                - sts:AssumeRole
        Policies:
          - PolicyName:  snsPublishPolicy
            PolicyDocument: 
              Version: '2012-10-17'
              Statement: 
                - Effect: Allow
                  Action: 
                    - sns:Publish
                  Resource: ${self:custom.snsTopicArn}
